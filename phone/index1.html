<!-- Add this new script section for sensors -->
<script>
    // ===========================
    // SENSOR TRACKING SYSTEM
    // ===========================
    
    const sensorData = {
        motion: {
            lastMovement: Date.now(),
            movements: [],
            isActive: false,
            steps: 0,
            fallDetected: false
        },
        location: {
            homeLocation: null,
            currentLocation: null,
            leftHomeToday: false,
            lastUpdate: null
        },
        light: {
            currentLevel: null,
            isDark: false,
            lastUpdate: null,
            darkDuration: 0
        }
    };

    let trackingActive = false;
    let homeLocation = null;

    // ===========================
    // 1. MOTION SENSOR
    // ===========================
    function startMotionTracking() {
        if (typeof DeviceMotionEvent === 'undefined') {
            console.log('âš ï¸ Motion sensor not supported');
            return;
        }

        // Request permission (iOS 13+)
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission()
                .then(permission => {
                    if (permission === 'granted') {
                        initMotionSensor();
                    }
                })
                .catch(console.error);
        } else {
            // Android or older iOS
            initMotionSensor();
        }
    }

    function initMotionSensor() {
        window.addEventListener('devicemotion', handleMotion);
        console.log('ðŸƒ Motion tracking started');
        
        // Send motion summary every 30 seconds
        setInterval(sendMotionSummary, 30000);
    }

    let stepCount = 0;
    let lastStepTime = 0;

    function handleMotion(event) {
        const acc = event.accelerationIncludingGravity;
        if (!acc || !acc.x) return;

        // Calculate magnitude
        const magnitude = Math.sqrt(
            acc.x * acc.x + 
            acc.y * acc.y + 
            acc.z * acc.z
        );

        const now = Date.now();

        // Activity detection (threshold: 12 m/sÂ²)
        if (magnitude > 12) {
            sensorData.motion.lastMovement = now;
            sensorData.motion.isActive = true;
            
            sensorData.motion.movements.push({
                magnitude: magnitude.toFixed(2),
                timestamp: now
            });

            // Keep only last 100
            if (sensorData.motion.movements.length > 100) {
                sensorData.motion.movements.shift();
            }

            // Step detection (simple algorithm)
            // Detect walking rhythm: magnitude spike + time gap
            if (magnitude > 13 && magnitude < 25) {
                if (now - lastStepTime > 300 && now - lastStepTime < 2000) {
                    stepCount++;
                    sensorData.motion.steps = stepCount;
                }
                lastStepTime = now;
            }
        }

        // Fall detection (sudden spike > 25 m/sÂ²)
        if (magnitude > 25) {
            detectFall(magnitude, now);
        }

        // Inactivity (no movement for 5 min)
        if (now - sensorData.motion.lastMovement > 5 * 60 * 1000) {
            sensorData.motion.isActive = false;
        }
    }

    function detectFall(magnitude, timestamp) {
        if (sensorData.motion.fallDetected && 
            timestamp - sensorData.motion.fallDetected < 10000) {
            return; // Debounce
        }

        sensorData.motion.fallDetected = timestamp;
        console.log('âš ï¸ FALL DETECTED!', magnitude);

        // Send immediate alert
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'fall_alert',
                magnitude: magnitude,
                timestamp: timestamp
            }));
        }
    }

    function sendMotionSummary() {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        const now = Date.now();
        const last5Min = sensorData.motion.movements.filter(m => 
            now - m.timestamp < 5 * 60 * 1000
        );

        ws.send(JSON.stringify({
            type: 'motion_update',
            isActive: sensorData.motion.isActive,
            movementCount: last5Min.length,
            steps: sensorData.motion.steps,
            lastMovement: sensorData.motion.lastMovement,
            timestamp: now
        }));

        console.log('ðŸ“Š Motion summary sent - Steps:', sensorData.motion.steps);
    }

    // ===========================
    // 2. LOCATION SENSOR
    // ===========================
    function startLocationTracking() {
        if (!navigator.geolocation) {
            console.log('âš ï¸ Location not supported');
            return;
        }

        // Get initial location as "home"
        navigator.geolocation.getCurrentPosition(
            position => {
                homeLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                sensorData.location.homeLocation = homeLocation;
                console.log('ðŸ  Home location set:', homeLocation);

                // Track location every 10 minutes
                setInterval(updateLocation, 10 * 60 * 1000);
                updateLocation(); // Initial update
            },
            error => console.error('Location error:', error)
        );
    }

    function updateLocation() {
        navigator.geolocation.getCurrentPosition(
            position => {
                const current = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                sensorData.location.currentLocation = current;
                sensorData.location.lastUpdate = Date.now();

                // Calculate distance from home (in meters)
                if (homeLocation) {
                    const distance = calculateDistance(
                        homeLocation.lat, homeLocation.lng,
                        current.lat, current.lng
                    );

                    // Consider "away from home" if >100m away
                    const isAway = distance > 100;
                    
                    if (isAway && !sensorData.location.leftHomeToday) {
                        sensorData.location.leftHomeToday = true;
                        console.log('ðŸš¶ User left home today');
                    }

                    // Send location update
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'location_update',
                            isHome: !isAway,
                            leftHomeToday: sensorData.location.leftHomeToday,
                            distance: Math.round(distance),
                            timestamp: Date.now()
                        }));
                    }
                }
            },
            error => console.error('Location update error:', error)
        );
    }

    // Haversine formula for distance
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Earth radius in meters
        const Ï†1 = lat1 * Math.PI/180;
        const Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180;
        const Î”Î» = (lon2-lon1) * Math.PI/180;

        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c;
    }

    // ===========================
    // 3. AMBIENT LIGHT SENSOR
    // ===========================
    function startLightTracking() {
        if ('AmbientLightSensor' in window) {
            try {
                const sensor = new AmbientLightSensor();
                sensor.addEventListener('reading', () => {
                    const lux = sensor.illuminance;
                    sensorData.light.currentLevel = lux;
                    sensorData.light.lastUpdate = Date.now();

                    // Consider "dark" if < 50 lux
                    const isDark = lux < 50;
                    
                    if (isDark !== sensorData.light.isDark) {
                        sensorData.light.isDark = isDark;
                        console.log(isDark ? 'ðŸŒ™ Room is dark' : 'â˜€ï¸ Room is bright');
                    }

                    // Track dark duration during daytime (8am - 8pm)
                    const hour = new Date().getHours();
                    if (hour >= 8 && hour <= 20 && isDark) {
                        sensorData.light.darkDuration++;
                    }
                });

                sensor.start();
                console.log('ðŸ’¡ Light sensor started');

                // Send light summary every 5 minutes
                setInterval(sendLightSummary, 5 * 60 * 1000);

            } catch (error) {
                console.log('âš ï¸ Light sensor not supported:', error);
            }
        } else {
            console.log('âš ï¸ Light sensor not available');
        }
    }

    function sendLightSummary() {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        ws.send(JSON.stringify({
            type: 'light_update',
            currentLevel: sensorData.light.currentLevel,
            isDark: sensorData.light.isDark,
            darkDuration: sensorData.light.darkDuration,
            timestamp: Date.now()
        }));
    }

    // ===========================
    // AUTO-START ALL SENSORS
    // ===========================
    function initAllSensors() {
        console.log('ðŸ”§ Initializing all sensors...');
        
        setTimeout(() => {
            startMotionTracking();
            startLocationTracking();
            startLightTracking();
            trackingActive = true;
        }, 2000); // Wait 2 seconds after page load
    }

    // Start sensors when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAllSensors);
    } else {
        initAllSensors();
    }

    // Reset daily counters at midnight
    function resetDailyCounters() {
        stepCount = 0;
        sensorData.motion.steps = 0;
        sensorData.location.leftHomeToday = false;
        sensorData.light.darkDuration = 0;
        console.log('ðŸ”„ Daily counters reset');
    }

    // Check for midnight every minute
    setInterval(() => {
        const now = new Date();
        if (now.getHours() === 0 && now.getMinutes() === 0) {
            resetDailyCounters();
        }
    }, 60000);
</script>